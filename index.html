<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-Sheet Tracker</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:20px; background:#f4f6f9; position:relative; }
  h1 { text-align:center; color:#333; margin-bottom:20px; }
  .tabs { display:flex; justify-content:center; flex-wrap:wrap; margin-bottom:10px; }
  .tab-btn { padding:10px 20px; margin:5px; cursor:pointer; border:none; border-radius:5px 5px 0 0; background:#ddd; font-weight:600; white-space:nowrap; }
  .tab-btn.active { background:#007bff; color:white; }
  #searchBox, #searchDate { padding:5px 10px; width:300px; max-width:90%; border-radius:5px; border:1px solid #ccc; font-size:14px; }
  .search-container { text-align:center; margin-bottom:10px; display:flex; justify-content:center; align-items:center; gap:5px; }
  .btn { background:#007bff; color:white; padding:4px 8px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
  .btn:hover { background:#0056b3; }
  .table-container { overflow-x:auto; overflow-y:auto; max-height:600px; margin-bottom:30px; background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  table { width:100%; border-collapse:collapse; min-width:1200px; }
  th, td { border:1px solid #ddd; text-align:center; padding:6px; font-size:13px; word-wrap:break-word; vertical-align:middle; }
  th { background:#007bff; color:white; position:sticky; top:0; z-index:10; }
  tr:nth-child(even) { background:#f9f9f9; }
  tr:hover { background:#f1f1f1; }
  td:nth-child(even) { background:#f0f8ff; }
  input[type=text], input[type=number], select, textarea { width:100%; border:none; font-size:13px; box-sizing:border-box; padding:2px; }
  input[type=text]:focus, input[type=number]:focus, select:focus, textarea:focus { outline:none; border:1px solid #007bff; }
  textarea { resize:none; overflow:hidden; }
  .checkbox { transform:scale(1.5); display:block; margin:auto; }
  .modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal-content { background:white; padding:20px; border-radius:8px; width:100%; max-width:600px;  max-height:90%; overflow-y:auto; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
  .modal h2 { margin-top:0; color:#da2121; }
  .close { float:right; font-size:22px; font-weight:bold; color:#333; cursor:pointer; }
  label { font-weight:500; margin-top:5px; display:block; font-size:13px; }
  .amount-box { display:flex; flex-wrap:wrap; gap:5px; justify-content:center; align-items:center; }
  .amount-box input { flex:1 1 45%; min-width:70px; }
  .amount-box label { font-size:12px; margin:0 5px; white-space:nowrap; }
  #logo { position:absolute; top:10px; left:10px; width:60px; height:auto; }
  footer { position:fixed; bottom:0; right:0; background:#007bff; color:white; padding:5px 15px; border-radius:8px 0 0 0; font-size:14px; }
  .profile { position:absolute; top:10px; right:30px; }
  .dropdown { position:relative; display:inline-block; }
  .dropdown-content { display:none; position:absolute; background-color:white; min-width:120px; box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2); z-index:1000; border-radius:5px; }
  .dropdown-content button { width:100%; padding:5px; text-align:left; background:none; border:none; cursor:pointer; font-size:13px; }
  .dropdown-content button:hover { background:#007bff; color:white; }
  .dropdown:hover .dropdown-content { display:block; }
  .auth-date { appearance:none; -webkit-appearance:none; -moz-appearance:none; border:none; background:transparent; color:#333; font-size:13px; padding:4px; cursor:text; text-align:center; width:120px; transition: all 0.2s ease; }
  .auth-date:focus { outline:none; border-bottom:1px solid #007bff; background:#f9f9f9; }
</style>
</head>
<body>

<img src="123.png" id="logo" alt="Logo" style="width:150px; height:auto;">

<div class="profile">
  <div class="dropdown">
    <button class="btn">Profile ‚ñæ</button>
    <div class="dropdown-content">
      <button><b>SAURAV CHAUHAN</b></button>
      <button onclick="createPDF()">Create PDF</button>
      <button onclick="createJSON()">Create JSON</button>
      <button onclick="uploadJSON()">Upload JSON</button>
    </div>
  </div>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="showSheet('api')">API Integration</button>
  <button class="tab-btn" onclick="showSheet('white')">White Label</button>
  <button class="tab-btn" onclick="showSheet('credit')">Credit Application</button>
  <button class="tab-btn" onclick="showSheet('auth')">Authorization</button>
</div>

<div class="search-container">
  <input type="text" id="searchBox" placeholder="Search..." oninput="filterTable()">
  <input type="date" id="searchDate" placeholder="Search by Date..." onchange="filterTable()" style="display:none;">
  <button class="btn" id="clearDateBtn" onclick="clearDateFilter()" style="display:none;">Clear</button>
</div>

<div style="text-align:center; margin:10px 0;">
  <button class="btn" onclick="addRow()">+ Add</button>
</div>

<div class="table-container">
  <table id="trackerTable">
    <thead id="tableHead"></thead>
    <tbody id="trackerBody"></tbody>
  </table>
</div>

<!-- Modal for Remarks -->
<div id="remarkModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Remark</h2>
    <div id="remarkFields"></div>
    <button class="btn" onclick="saveRemarks()">Save Remark</button>
  </div>
</div>

<footer>Developed by <b>SAURAV CHAUHAN</b></footer>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxaajA6NXYhpXKoACGpRbHf8iW5Zet_Lwut40ILCm1zNd0UtLFUsiy_-lLdJ40Ie-eh/exec"; // Replace with your deployed Apps Script URL

let currentSheet = 'api';
let currentRemarkIndex = null;
let allData = { api:[], white:[], credit:[], auth:[] };
const sheetColumns = {
  api:["#", "AGT Code","Company Name","Info Sent","Info Received","Trade","VAT","Service","XML","NDA","Docs Sent","Received Docs","Invoice","Bill Number","Teams Group","Sent to Sowmya","Testing Started","Live Token","Remarks","Actions"],
  white:["#", "AGT Code","Company Name","Info Sent","Info Received","Trade","VAT","Service","Agreement","NDA","Docs Sent","Received Docs","Invoice","Bill Number","Teams Group","Sent to Sowmya","Testing Started","Live Token","Remarks","Actions"],
  credit:["#", "AGT Code","Company Name","Info Sent","Info Received","Trade","VAT","Service","Credit","Docs Sent","Received Docs","Status","Amount Mode","Remarks","Actions"],
  auth:["#", "AGT Code","Company Name","Sales Person","Remarks","Date","Actions"]
};
const currentSheetSheetNames = { api:"API Integration", white:"White Label", credit:"Credit Application", auth:"Authorization" };

// ------------------ Sheet Functions ------------------

async function fetchSheetData(sheet) {
  const res = await fetch(`${GOOGLE_SCRIPT_URL}?sheetName=${encodeURIComponent(currentSheetSheetNames[sheet])}`);
  const data = await res.json();
  allData[sheet] = data.rows || [];
  loadData();
}

function saveToSheet(rowIndex) {
  const row = allData[currentSheet][rowIndex];
  fetch(GOOGLE_SCRIPT_URL, {
    method:'POST',
    body: JSON.stringify({sheetName: currentSheetSheetNames[currentSheet], action:'update', index: rowIndex, row}),
  }).then(res=>res.json()).then(r=>console.log('Saved', r)).catch(e=>console.error(e));
}

function addRow() {
  const base = {agtCode:'', companyName:'', infoSent:false, infoReceived:false, trade:false, vat:false, service:false, xml:false, nda:false, docsSent:false, docsReceived:false, invoice:false, billNumber:'', teams:false, sentSowmya:false, testing:false, live:false, remarks:''};
  if(currentSheet==='credit') base.credit=false, base.status='Not Approved', base.amountMode='Online', base.amountOnline='', base.amountOffline='';
  if(currentSheet==='auth') base.salesPerson='', base.date=new Date().toISOString().split('T')[0];
  allData[currentSheet].push(base);
  loadData();
  // Save newly added row to Google Sheet
  fetch(GOOGLE_SCRIPT_URL, {method:'POST', body: JSON.stringify({sheetName:currentSheetSheetNames[currentSheet], action:'add', row: base})});
}

function deleteRow(index) {
  if(!confirm('Are you sure to delete this row?')) return;
  allData[currentSheet].splice(index,1);
  loadData();
  fetch(GOOGLE_SCRIPT_URL, {method:'POST', body: JSON.stringify({sheetName: currentSheetSheetNames[currentSheet], action:'delete', index})});
}

// ------------------ Table Rendering ------------------

function showSheet(sheet){
  currentSheet = sheet;
  document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick*="${sheet}"]`).classList.add('active');
  document.getElementById('searchDate').style.display = (sheet==='auth') ? 'block' : 'none';
  document.getElementById('clearDateBtn').style.display = (sheet==='auth') ? 'inline-block' : 'none';
  updateTableHead();
  fetchSheetData(sheet);
}

function updateTableHead() {
  document.getElementById("tableHead").innerHTML = "<tr>"+sheetColumns[currentSheet].map(h=>`<th>${h}</th>`).join('')+"</tr>";
}

function checkbox(item,index,field){
  return `<td><input type="checkbox" class="checkbox" ${item[field]?'checked':''} onchange="updateData(${index},'${field}',this.checked)"></td>`;
}

function updateData(index,field,value){
  allData[currentSheet][index][field] = value;
  saveToSheet(index);
  filterTable();
}

function loadData(){
  const tbody = document.getElementById('trackerBody'); tbody.innerHTML='';
  allData[currentSheet].forEach((item,index)=>{
    let rowHtml=`<tr><td>${index+1}</td>
    <td contenteditable="true" oninput="updateData(${index},'agtCode',this.innerText)">${item.agtCode||''}</td>
    <td contenteditable="true" oninput="updateData(${index},'companyName',this.innerText)">${item.companyName||''}</td>`;

    if(currentSheet==='auth'){
      rowHtml+=`<td contenteditable="true" oninput="updateData(${index},'salesPerson',this.innerText)">${item.salesPerson||''}</td>`;
      rowHtml+=`<td><button class="btn" onclick="openRemarks(${index})">üìù</button></td>`;
      rowHtml+=`<td><input type="date" class="auth-date" value="${item.date||new Date().toISOString().split('T')[0]}" onchange="updateData(${index},'date',this.value)"></td>`;
    } else if(currentSheet==='credit'){
      rowHtml+=checkbox(item,index,'infoSent')+checkbox(item,index,'infoReceived')+checkbox(item,index,'trade')+checkbox(item,index,'vat')+checkbox(item,index,'service')+checkbox(item,index,'credit')+checkbox(item,index,'docsSent')+checkbox(item,index,'docsReceived');
      rowHtml+=`<td><select onchange="updateData(${index},'status',this.value)">
        <option ${item.status==='Approved'?'selected':''}>Approved</option>
        <option ${item.status==='Not Approved'?'selected':''}>Not Approved</option></select></td>`;
      rowHtml+=`<td><select onchange="updateData(${index},'amountMode',this.value); toggleAmountInputs(${index})">
        <option ${item.amountMode==='Online'?'selected':''}>Online</option>
        <option ${item.amountMode==='Offline'?'selected':''}>Offline</option>
        <option ${item.amountMode==='Both'?'selected':''}>Both</option></select>
        <div id="amountDiv-${index}" class="amount-box"></div></td>`;
      rowHtml+=`<td><button class="btn" onclick="openRemarks(${index})">üìù</button></td>`;
    } else {
      rowHtml+=checkbox(item,index,'infoSent')+checkbox(item,index,'infoReceived')+checkbox(item,index,'trade')+checkbox(item,index,'vat')+checkbox(item,index,'service')+checkbox(item,index,'xml')+checkbox(item,index,'nda')+checkbox(item,index,'docsSent')+checkbox(item,index,'docsReceived')+checkbox(item,index,'invoice');
      rowHtml+=`<td contenteditable="true" oninput="updateData(${index},'billNumber',this.innerText)">${item.billNumber||''}</td>`;
      rowHtml+=checkbox(item,index,'teams')+checkbox(item,index,'sentSowmya')+checkbox(item,index,'testing')+`<td><input type="checkbox" ${item.live?'checked':''} class="checkbox" onchange="updateData(${index},'live',this.checked)"></td>`;
      rowHtml+=`<td><button class="btn" onclick="openRemarks(${index})">üìù</button></td>`;
    }

    rowHtml+=`<td><button class="btn" style="background:#dc3545;" onclick="deleteRow(${index})">Delete</button></td></tr>`;
    tbody.innerHTML+=rowHtml;
    if(currentSheet==='credit') toggleAmountInputs(index);
  });
  filterTable();
}

// ------------------ Remarks ------------------

function openRemarks(index){
  currentRemarkIndex = index;
  const data = allData[currentSheet][index];
  const remarkFields = document.getElementById('remarkFields');
  remarkFields.innerHTML = `<label>Remark:</label>`;
  const textarea = document.createElement('textarea');
  textarea.id = 'remarkTextarea';
  textarea.style.width='100%';
  textarea.style.minHeight='200px';
  textarea.style.maxHeight='400px';
  textarea.style.resize='none';
  textarea.style.overflowY='hidden';
  textarea.value = data.remarks||'';
  remarkFields.appendChild(textarea);

  textarea.addEventListener('input',()=>autoResizeWithMax(textarea));
  textarea.addEventListener('keydown', function(e) {
    if (e.key==='Enter') { e.preventDefault();
      const start=this.selectionStart;
      const end=this.selectionEnd;
      this.value=this.value.substring(0,start)+"\n- "+this.value.substring(end);
      this.selectionStart=this.selectionEnd=start+3;
    } else if(this.value.length===0 && e.key!=='Backspace'){
      setTimeout(()=>{if(!this.value.startsWith('- ')) this.value='- '+this.value;},0);
    }
  });

  autoResizeWithMax(textarea);
  document.getElementById('remarkModal').style.display='flex';
}

function saveRemarks(){
  const remark=document.getElementById('remarkTextarea').value;
  allData[currentSheet][currentRemarkIndex].remarks=remark;
  saveToSheet(currentRemarkIndex);
  closeModal();
  loadData();
}

function closeModal(){ document.getElementById('remarkModal').style.display='none'; }
function autoResizeWithMax(textarea){ textarea.style.height='auto'; textarea.style.height=Math.min(textarea.scrollHeight,400)+'px'; textarea.style.overflowY=(textarea.scrollHeight>400)?'auto':'hidden'; }

// ------------------ Credit Amount Box ------------------

function toggleAmountInputs(index){
  const item=allData[currentSheet][index];
  if(currentSheet!=='credit') return;
  const div=document.getElementById(`amountDiv-${index}`);
  let html='';
  if(item.amountMode==='Online') html=`<input type="number" placeholder="Online" value="${item.amountOnline||''}" oninput="updateData(${index},'amountOnline',this.value)">`;
  else if(item.amountMode==='Offline') html=`<input type="number" placeholder="Offline" value="${item.amountOffline||''}" oninput="updateData(${index},'amountOffline',this.value)">`;
  else if(item.amountMode==='Both') html=`<input type="number" placeholder="Online" value="${item.amountOnline||''}" oninput="updateData(${index},'amountOnline',this.value)"><input type="number" placeholder="Offline" value="${item.amountOffline||''}" oninput="updateData(${index},'amountOffline',this.value)">`;
  div.innerHTML=html;
}

// ------------------ Search / Filter ------------------

function filterTable(){
  const search=document.getElementById('searchBox').value.toLowerCase();
  const dateFilter=document.getElementById('searchDate').value;
  const tbody=document.getElementById('trackerBody');
  Array.from(tbody.rows).forEach((row,i)=>{
    const rowData=allData[currentSheet][i];
    let match=false;
    if(search){
      for(const key in rowData){
        if(typeof rowData[key]==='string' && rowData[key].toLowerCase().includes(search)){
          match=true; break;
        }
      }
    } else match=true;
    if(currentSheet==='auth' && dateFilter){
      match=match && (rowData.date===dateFilter);
    }
    row.style.display=match?'':'none';
  });
}

function clearDateFilter(){ document.getElementById('searchDate').value=''; filterTable(); }

// ------------------ Profile Actions ------------------

function createPDF(){ alert("PDF Functionality not implemented yet"); }
function createJSON(){ alert("JSON Functionality not implemented yet"); }
function uploadJSON(){ alert("Upload JSON Functionality not implemented yet"); }

// ------------------ Initialize ------------------

document.addEventListener('DOMContentLoaded',()=>{ showSheet('api'); });
</script>

</body>
</html>
